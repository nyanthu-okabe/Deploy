<!doctype html>
<html lang="ja">
    <head>
        <meta charset="utf-8" />
        <title>VSCodeÈ¢®PHPÁí∞Â¢É</title>
        <style>
            html,
            body {
                height: 100%;
                margin: 0;
            }

            body {
                display: flex;
                flex-direction: row; /* Â∑¶„Çµ„Ç§„Éâ„Éê„Éº + Âè≥„É°„Ç§„É≥ */
                font-family: "Segoe UI", sans-serif;
                background-color: #1e1e1e;
                color: #cccccc;
            }

            /* „Çµ„Ç§„Éâ„Éê„Éº */
            .sidebar {
                width: 220px;
                background-color: #252526;
                height: 100%;
                display: flex;
                flex-direction: column;
                padding: 10px;
                box-sizing: border-box;
            }
            .sidebar h3 {
                margin-top: 0;
                color: #ffffff;
                font-size: 14px;
                text-align: center;
            }
            .file-list {
                flex: 1;
                overflow-y: auto;
                margin-top: 10px;
                padding-left: 0;
            }
            .file-list li {
                margin-bottom: 6px;
                font-size: 13px;
                list-style: none;
            }
            .file-list a {
                color: #0e639c;
                text-decoration: none;
                margin-left: 4px;
            }
            .file-list a:hover {
                text-decoration: underline;
            }

            /* „É°„Ç§„É≥„Ç®„É™„Ç¢ */
            .main {
                flex: 1;
                display: flex;
                flex-direction: column;
                padding: 10px;
                box-sizing: border-box;
                height: 100%;
            }

            .flash {
                margin-bottom: 10px;
                color: #9cdcfe;
                font-size: 13px;
            }

            .controls {
                display: flex;
                gap: 10px;
                margin-bottom: 10px;
            }
            .controls input[type="text"] {
                flex: 1;
                padding: 5px;
                border-radius: 3px;
                border: 1px solid #555;
                background-color: #1e1e1e;
                color: #fff;
            }
            .controls button {
                padding: 6px 12px;
                border-radius: 3px;
                border: none;
                background-color: #0e639c;
                color: #fff;
                cursor: pointer;
            }
            .controls button:hover {
                background-color: #1177bb;
            }

            #editor {
                flex: 1;
                border: 1px solid #333;
                min-height: 300px;
            }
        </style>

        <script src="https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs/loader.min.js"></script>
    </head>
    <body>
        <!-- „Çµ„Ç§„Éâ„Éê„Éº -->
        <div class="sidebar">
            <h3>„Éï„Ç°„Ç§„É´‰∏ÄË¶ß</h3>
            <ul class="file-list">
                {% for f in files %}
                <li>
                    {{ f }}
                    <a
                        href="{{ url_for('run_php', filename=f) }}"
                        target="_blank"
                        >‚ñ∂</a
                    >
                    <a href="{{ url_for('load_file', filename=f) }}">‚úé</a>
                    <a href="{{ url_for('delete_file', filename=f) }}">üóëÔ∏è</a>
                </li>
                {% endfor %}
            </ul>
        </div>

        <!-- „É°„Ç§„É≥„Ç®„É™„Ç¢ -->
        <div class="main">
            {% with messages = get_flashed_messages() %} {% if messages %}
            <div class="flash">
                {% for msg in messages %}
                <div>{{ msg }}</div>
                {% endfor %}
            </div>
            {% endif %} {% endwith %}

            <form method="post">
                <div class="controls">
                    <input
                        type="text"
                        name="filename"
                        placeholder="„Éï„Ç°„Ç§„É´Âêç"
                        value="{{ load_filename if load_filename else 'user.php' }}"
                    />
                    <button type="submit">üíæ ‰øùÂ≠ò</button>
                </div>
                <div id="editor"></div>
                <textarea
                    id="code"
                    name="user_input"
                    style="display: none"
                ></textarea>
            </form>
        </div>

        <script>
            // HTML„Ç®„É≥„ÉÜ„Ç£„ÉÜ„Ç£„Çí„Éá„Ç≥„Éº„Éâ„Åô„ÇãÈñ¢Êï∞
            function decodeHTMLEntities(text) {
                const textarea = document.createElement("textarea");
                textarea.innerHTML = text;
                return textarea.value;
            }

            // Jinja„Åã„ÇâÊù•„ÅüÂÜÖÂÆπÔºà„Ç®„Çπ„Ç±„Éº„Éó„Åï„Çå„Åü„Åæ„ÅæÊ∏°„Å£„Å¶„Åè„ÇãÔºâ
            const rawCode = `{{ load_content|e if load_content else "" }}`;
            const initialCode = decodeHTMLEntities(rawCode);

            // Monaco Editor Ë™≠„ÅøËæº„ÅøË®≠ÂÆö
            require.config({
                paths: {
                    vs: "https://cdnjs.cloudflare.com/ajax/libs/monaco-editor/0.45.0/min/vs",
                },
            });

            require(["vs/editor/editor.main"], function () {
                window.editor = monaco.editor.create(
                    document.getElementById("editor"),
                    {
                        value: initialCode,
                        language: "php",
                        theme: "vs-dark",
                        automaticLayout: true,
                    },
                );
            });

            // „Éï„Ç©„Éº„É†ÈÄÅ‰ø°ÊôÇ„Å´„Ç®„Éá„Ç£„Çø„ÅÆÂÜÖÂÆπ„Çí hidden input „Å´„Çª„ÉÉ„Éà
            document
                .querySelector("form")
                .addEventListener("submit", function () {
                    document.getElementById("code").value =
                        window.editor.getValue();
                });
        </script>
    </body>
</html>
